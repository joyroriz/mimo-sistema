<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Produtos de Interesse - Sistema MIMO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/toast-notifications.css" rel="stylesheet">
    <style>
        :root {
            --mimo-gradient: linear-gradient(135deg, #FF8E63 0%, #FF7EB0 50%, #63A4FF 100%);
        }
        
        body {
            background: linear-gradient(135deg, #FCFBF8 0%, #f8f9fa 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .test-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .btn-mimo {
            background: var(--mimo-gradient);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            margin: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .btn-mimo:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            color: white;
        }
        
        .interesse-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #007bff;
        }
        
        .interesse-item.baixo { border-left-color: #6c757d; }
        .interesse-item.medio { border-left-color: #ffc107; }
        .interesse-item.alto { border-left-color: #fd7e14; }
        .interesse-item.muito_alto { border-left-color: #dc3545; }
        
        .nivel-badge {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-card">
            <h1 class="text-center mb-4">
                <i class="bi bi-heart-fill me-2"></i>
                Teste Sistema de Produtos de Interesse
            </h1>
            <p class="text-center text-muted mb-4">
                Sistema para associar produtos de interesse aos clientes
            </p>
            
            <div class="row">
                <div class="col-md-6">
                    <h5>Adicionar Interesse</h5>
                    
                    <div class="mb-3">
                        <label for="cliente_id" class="form-label">Cliente ID</label>
                        <input type="number" class="form-control" id="cliente_id" value="1" min="1">
                    </div>
                    
                    <div class="mb-3">
                        <label for="produto_id" class="form-label">Produto ID</label>
                        <input type="number" class="form-control" id="produto_id" value="1" min="1">
                    </div>
                    
                    <div class="mb-3">
                        <label for="nivel_interesse" class="form-label">N√≠vel de Interesse</label>
                        <select class="form-select" id="nivel_interesse">
                            <option value="baixo">üîµ Baixo</option>
                            <option value="medio" selected>üü° M√©dio</option>
                            <option value="alto">üü† Alto</option>
                            <option value="muito_alto">üî¥ Muito Alto</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacoes" class="form-label">Observa√ß√µes</label>
                        <textarea class="form-control" id="observacoes" rows="3" 
                                  placeholder="Observa√ß√µes sobre o interesse..."></textarea>
                    </div>
                    
                    <button class="btn btn-mimo" onclick="adicionarInteresse()">
                        <i class="bi bi-plus-circle me-2"></i>Adicionar Interesse
                    </button>
                    
                    <button class="btn btn-mimo" onclick="carregarInteressesCliente()">
                        <i class="bi bi-person me-2"></i>Carregar por Cliente
                    </button>
                    
                    <button class="btn btn-mimo" onclick="carregarEstatisticas()">
                        <i class="bi bi-bar-chart me-2"></i>Carregar Estat√≠sticas
                    </button>
                </div>
                
                <div class="col-md-6">
                    <h5>Interesses do Cliente <span id="cliente-numero">1</span></h5>
                    
                    <div id="lista-interesses">
                        <p class="text-muted">Nenhum interesse carregado</p>
                    </div>
                </div>
            </div>
            
            <hr class="my-4">
            
            <div class="row">
                <div class="col-md-6">
                    <h5>Estat√≠sticas</h5>
                    <div id="estatisticas">
                        <p><strong>Total de Interesses:</strong> <span id="total-interesses">0</span></p>
                        <p><strong>Clientes com Interesse:</strong> <span id="clientes-interesse">0</span></p>
                        <p><strong>Produtos com Interesse:</strong> <span id="produtos-interesse">0</span></p>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <h5>Produtos Mais Desejados</h5>
                    <div id="produtos-populares">
                        <p class="text-muted">Carregue as estat√≠sticas para ver</p>
                    </div>
                </div>
            </div>
            
            <hr class="my-4">
            
            <div class="row">
                <div class="col-12">
                    <h5>Testes R√°pidos</h5>
                    <button class="btn btn-mimo" onclick="testeCompleto()">
                        üß™ Teste Completo
                    </button>
                    <button class="btn btn-mimo" onclick="criarInteressesTeste()">
                        üìù Criar Interesses de Teste
                    </button>
                    <button class="btn btn-mimo" onclick="limparTudo()">
                        üóëÔ∏è Limpar Interface
                    </button>
                </div>
            </div>
            
            <div class="mt-4 text-center">
                <a href="/" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Voltar ao Dashboard
                </a>
            </div>
        </div>
    </div>

    <script>
        // Implementa√ß√£o da fun√ß√£o showToast
        const showToast = {
            success: function(title, message) { this.show('success', title, message); },
            error: function(title, message) { this.show('error', title, message); },
            warning: function(title, message) { this.show('warning', title, message); },
            info: function(title, message) { this.show('info', title, message); },
            show: function(type, title, message) {
                let container = document.getElementById('toast-container');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'toast-container';
                    container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 350px;';
                    document.body.appendChild(container);
                }
                const toast = document.createElement('div');
                const colors = {
                    success: { bg: '#d4edda', border: '#c3e6cb', text: '#155724' },
                    error: { bg: '#f8d7da', border: '#f5c6cb', text: '#721c24' },
                    warning: { bg: '#fff3cd', border: '#ffeaa7', text: '#856404' },
                    info: { bg: '#d1ecf1', border: '#bee5eb', text: '#0c5460' }
                };
                const color = colors[type] || colors.info;
                toast.style.cssText = `background: ${color.bg}; border: 1px solid ${color.border}; color: ${color.text}; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);`;
                toast.innerHTML = `<div style="display: flex; align-items: center; justify-content: space-between;"><div><strong>${title}</strong><div style="margin-top: 5px;">${message}</div></div><button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 18px; cursor: pointer; color: ${color.text};">√ó</button></div>`;
                container.appendChild(toast);
                setTimeout(() => toast.remove(), 5000);
            }
        };
    </script>
    <script>
        // Adicionar interesse
        async function adicionarInteresse() {
            const dados = {
                cliente_id: parseInt(document.getElementById('cliente_id').value),
                produto_id: parseInt(document.getElementById('produto_id').value),
                nivel_interesse: document.getElementById('nivel_interesse').value,
                observacoes: document.getElementById('observacoes').value
            };
            
            try {
                const response = await fetch('/api/produtos-interesse', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dados)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showToast.success('Interesse Adicionado', 'Produto de interesse salvo com sucesso!');
                    document.getElementById('observacoes').value = '';
                    carregarInteressesCliente();
                    carregarEstatisticas();
                } else {
                    showToast.error('Erro', result.error || 'Erro ao adicionar interesse');
                }
                
            } catch (error) {
                console.error('Erro ao adicionar interesse:', error);
                showToast.error('Erro', 'Erro de conex√£o');
            }
        }
        
        // Carregar interesses por cliente
        async function carregarInteressesCliente() {
            const clienteId = document.getElementById('cliente_id').value;
            document.getElementById('cliente-numero').textContent = clienteId;
            
            try {
                const response = await fetch(`/api/produtos-interesse/cliente/${clienteId}`);
                const interesses = await response.json();
                
                const lista = document.getElementById('lista-interesses');
                
                if (interesses.length === 0) {
                    lista.innerHTML = '<p class="text-muted">Nenhum interesse encontrado</p>';
                    return;
                }
                
                lista.innerHTML = interesses.map(interesse => `
                    <div class="interesse-item ${interesse.nivel_interesse}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${interesse.produto_nome}</h6>
                                <small class="text-muted">Categoria: ${interesse.categoria || 'N/A'}</small>
                                <br>
                                <span class="badge nivel-badge bg-secondary">${getNivelTexto(interesse.nivel_interesse)}</span>
                                <span class="badge bg-info">R$ ${parseFloat(interesse.preco || 0).toFixed(2)}</span>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="removerInteresse(${interesse.cliente_id}, ${interesse.produto_id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        ${interesse.observacoes ? `<div class="mt-2"><small class="text-muted">${interesse.observacoes}</small></div>` : ''}
                    </div>
                `).join('');
                
                showToast.success('Interesses Carregados', `${interesses.length} interesses encontrados`);
                
            } catch (error) {
                console.error('Erro ao carregar interesses:', error);
                showToast.error('Erro', 'N√£o foi poss√≠vel carregar os interesses');
            }
        }
        
        // Carregar estat√≠sticas
        async function carregarEstatisticas() {
            try {
                const response = await fetch('/api/produtos-interesse/estatisticas');
                const stats = await response.json();
                
                document.getElementById('total-interesses').textContent = stats.geral.total_interesses || 0;
                document.getElementById('clientes-interesse').textContent = stats.geral.clientes_com_interesse || 0;
                document.getElementById('produtos-interesse').textContent = stats.geral.produtos_com_interesse || 0;
                
                // Produtos populares
                const container = document.getElementById('produtos-populares');
                if (stats.produtos_populares && stats.produtos_populares.length > 0) {
                    container.innerHTML = stats.produtos_populares.map(produto => `
                        <div class="d-flex justify-content-between">
                            <span>${produto.nome}</span>
                            <span class="badge bg-primary">${produto.total_interessados}</span>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p class="text-muted">Nenhum produto com interesse</p>';
                }
                
                showToast.info('Estat√≠sticas Atualizadas', 'Dados carregados com sucesso');
                
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
                showToast.error('Erro', 'N√£o foi poss√≠vel carregar as estat√≠sticas');
            }
        }
        
        // Remover interesse
        async function removerInteresse(clienteId, produtoId) {
            if (!confirm('Deseja remover este interesse?')) return;
            
            try {
                const response = await fetch(`/api/produtos-interesse/${clienteId}/${produtoId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showToast.warning('Interesse Removido', 'Produto removido da lista de interesses');
                    carregarInteressesCliente();
                    carregarEstatisticas();
                } else {
                    showToast.error('Erro', result.error || 'Erro ao remover interesse');
                }
                
            } catch (error) {
                console.error('Erro ao remover interesse:', error);
                showToast.error('Erro', 'Erro de conex√£o');
            }
        }
        
        // Fun√ß√µes auxiliares
        function getNivelTexto(nivel) {
            const niveis = {
                'baixo': 'üîµ Baixo',
                'medio': 'üü° M√©dio',
                'alto': 'üü† Alto',
                'muito_alto': 'üî¥ Muito Alto'
            };
            return niveis[nivel] || nivel;
        }
        
        // Testes automatizados
        async function criarInteressesTeste() {
            const interessesTeste = [
                { cliente: 1, produto: 1, nivel: 'alto', obs: 'Cliente demonstrou muito interesse' },
                { cliente: 1, produto: 2, nivel: 'medio', obs: 'Interesse moderado' },
                { cliente: 2, produto: 1, nivel: 'muito_alto', obs: 'Cliente quer comprar urgente' },
                { cliente: 2, produto: 3, nivel: 'baixo', obs: 'Apenas curiosidade' }
            ];
            
            for (const interesse of interessesTeste) {
                document.getElementById('cliente_id').value = interesse.cliente;
                document.getElementById('produto_id').value = interesse.produto;
                document.getElementById('nivel_interesse').value = interesse.nivel;
                document.getElementById('observacoes').value = interesse.obs;
                
                await adicionarInteresse();
                await new Promise(resolve => setTimeout(resolve, 500)); // Delay entre cria√ß√µes
            }
        }
        
        async function testeCompleto() {
            showToast.info('Iniciando Teste', 'Executando teste completo do sistema...');
            
            await criarInteressesTeste();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await carregarInteressesCliente();
            await carregarEstatisticas();
            
            showToast.success('Teste Conclu√≠do', 'Todas as funcionalidades testadas com sucesso!');
        }
        
        function limparTudo() {
            document.getElementById('observacoes').value = '';
            document.getElementById('lista-interesses').innerHTML = '<p class="text-muted">Nenhum interesse carregado</p>';
            document.getElementById('total-interesses').textContent = '0';
            document.getElementById('clientes-interesse').textContent = '0';
            document.getElementById('produtos-interesse').textContent = '0';
            document.getElementById('produtos-populares').innerHTML = '<p class="text-muted">Carregue as estat√≠sticas para ver</p>';
            showToast.info('Limpo', 'Interface resetada');
        }
        
        // Carregar dados iniciais
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                showToast.info('Sistema de Produtos de Interesse', 'Teste todas as funcionalidades usando os controles!');
                carregarEstatisticas();
            }, 500);
        });
    </script>
</body>
</html>
