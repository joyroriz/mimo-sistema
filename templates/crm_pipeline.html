<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Pipeline - Sistema MIMO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/toast-notifications.css" rel="stylesheet">
    <style>
        :root {
            --mimo-gradient: linear-gradient(135deg, #FF8E63 0%, #FF7EB0 50%, #63A4FF 100%);
        }
        
        body {
            background: linear-gradient(135deg, #FCFBF8 0%, #f8f9fa 100%);
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .pipeline-container {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding: 20px 0;
            min-height: 70vh;
        }
        
        .pipeline-stage {
            min-width: 300px;
            max-width: 320px;
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .stage-header {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            margin-bottom: 20px;
            position: relative;
        }
        
        .stage-prospect { background: #6c757d; }
        .stage-contato { background: #0dcaf0; }
        .stage-negociacao { background: #fd7e14; }
        .stage-cliente { background: #198754; }
        
        .prospect-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            cursor: move;
            transition: all 0.3s ease;
            border-left: 4px solid #ddd;
            position: relative;
        }
        
        .prospect-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.15);
        }
        
        .prospect-card.dragging {
            opacity: 0.6;
            transform: rotate(3deg);
        }
        
        .card-nome {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .card-empresa {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        
        .card-valor {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .card-probabilidade {
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            color: #495057;
            float: right;
        }
        
        .card-contato {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 8px;
        }
        
        .card-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        
        .mimo-gradient-text {
            background: var(--mimo-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }
        
        .btn-mimo {
            background: var(--mimo-gradient);
            border: none;
            color: white;
            border-radius: 25px;
            padding: 8px 20px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }
        
        .btn-mimo:hover {
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .stats-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .drop-zone {
            min-height: 80px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-style: italic;
            margin-top: 10px;
        }
        
        .drop-zone.drag-over {
            border-color: #0dcaf0;
            background: rgba(13, 202, 240, 0.1);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg" style="background: var(--mimo-gradient);">
        <div class="container">
            <a class="navbar-brand text-white fw-bold" href="/">
                <i class="bi bi-heart-fill me-2"></i>MIMO
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link text-white" href="/">Dashboard</a>
                <a class="nav-link text-white" href="/clientes">Clientes</a>
                <a class="nav-link text-white" href="/produtos">Produtos</a>
                <a class="nav-link text-white" href="/vendas">Vendas</a>
                <a class="nav-link text-white" href="/entregas">Entregas</a>
                <a class="nav-link text-white active" href="/crm">CRM</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mimo-gradient-text">
                <i class="bi bi-people me-2"></i>CRM Pipeline
            </h1>
            <div class="d-flex gap-2">
                <button class="btn-mimo" data-bs-toggle="modal" data-bs-target="#novoProspectModal">
                    <i class="bi bi-plus-circle me-1"></i>Novo Prospect
                </button>
                <button class="btn btn-outline-primary" onclick="atualizarPipeline()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Atualizar
                </button>
            </div>
        </div>
        
        <!-- Estatísticas rápidas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <i class="bi bi-people display-6 text-primary mb-2"></i>
                    <h4 class="mimo-gradient-text" id="total-prospects">0</h4>
                    <p class="text-muted mb-0">Total Prospects</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <i class="bi bi-currency-dollar display-6 text-success mb-2"></i>
                    <h4 class="mimo-gradient-text" id="valor-pipeline">R$ 0</h4>
                    <p class="text-muted mb-0">Valor Pipeline</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <i class="bi bi-graph-up display-6 text-warning mb-2"></i>
                    <h4 class="mimo-gradient-text" id="taxa-conversao">0%</h4>
                    <p class="text-muted mb-0">Taxa Conversão</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <i class="bi bi-graph-up display-6 text-info mb-2"></i>
                    <h4 class="mimo-gradient-text" id="taxa-conversao">0%</h4>
                    <p class="text-muted mb-0">Taxa Conversão</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <i class="bi bi-check-circle display-6 text-info mb-2"></i>
                    <h4 class="mimo-gradient-text" id="ticket-medio">R$ 0</h4>
                    <p class="text-muted mb-0">Ticket Médio</p>
                </div>
            </div>
        </div>
        
        <div class="pipeline-container" id="pipeline-container">
            <!-- Estágios serão carregados via JavaScript -->
        </div>
    </div>

    <!-- Modal Novo Prospect -->
    <div class="modal fade" id="novoProspectModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Novo Prospect</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formNovoProspect">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nome *</label>
                                    <input type="text" class="form-control" name="nome" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" name="email">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Telefone</label>
                                    <input type="text" class="form-control" name="telefone">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">WhatsApp</label>
                                    <input type="text" class="form-control" name="whatsapp">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Empresa</label>
                                    <input type="text" class="form-control" name="empresa">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Cargo</label>
                                    <input type="text" class="form-control" name="cargo">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Origem</label>
                                    <select class="form-control" name="origem">
                                        <option value="site">Site</option>
                                        <option value="redes_sociais">Redes Sociais</option>
                                        <option value="indicacao">Indicação</option>
                                        <option value="evento">Evento</option>
                                        <option value="ligacao_fria">Ligação Fria</option>
                                        <option value="outros">Outros</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Valor Estimado</label>
                                    <input type="number" class="form-control" name="valor_estimado" step="0.01">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control" name="observacoes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarProspect()">Salvar Prospect</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let pipelineData = {};
        let currentProspectId = null;
        let currentNovoEstagio = null;
        
        const estagiosConfig = {
            'prospect': { nome: 'Prospect', probabilidade: 25, cor: '#6c757d' },
            'contato': { nome: 'Contato', probabilidade: 50, cor: '#0dcaf0' },
            'negociacao': { nome: 'Negociação', probabilidade: 75, cor: '#fd7e14' },
            'cliente': { nome: 'Cliente', probabilidade: 100, cor: '#198754' }
        };
        
        // Carregar pipeline
        async function carregarPipeline() {
            try {
                const response = await fetch('/api/crm/prospects');
                const result = await response.json();

                if (result.success) {
                    pipelineData = result.data;
                    renderizarPipeline();
                    atualizarEstatisticas();
                } else {
                    console.error('Erro ao carregar pipeline:', result.error);
                }
            } catch (error) {
                console.error('Erro na requisição:', error);
            }
        }
        
        // Renderizar pipeline
        function renderizarPipeline() {
            const container = document.getElementById('pipeline-container');

            if (!container) {
                console.error('Container pipeline-container não encontrado!');
                return;
            }

            container.innerHTML = '';

            Object.keys(estagiosConfig).forEach(estagio => {
                const stage = criarEstagio(estagio, pipelineData[estagio] || []);
                container.appendChild(stage);
            });

            configurarDragAndDrop();
        }
        
        // Criar estágio
        function criarEstagio(estagio, prospects) {
            const config = estagiosConfig[estagio];
            const stage = document.createElement('div');
            stage.className = 'pipeline-stage';
            stage.dataset.estagio = estagio;
            
            const valorTotal = prospects.reduce((sum, p) => sum + (parseFloat(p.valor_estimado) || 0), 0);
            
            stage.innerHTML = `
                <div class="stage-header stage-${estagio}">
                    ${config.nome}
                    <div class="d-flex justify-content-between mt-2">
                        <span class="badge bg-light text-dark">${prospects.length}</span>
                        <small>R$ ${valorTotal.toFixed(2)}</small>
                    </div>
                </div>
                <div class="prospect-cards" id="cards-${estagio}">
                    ${prospects.map(prospect => criarCardProspect(prospect)).join('')}
                </div>
                ${prospects.length === 0 ? '<div class="drop-zone">Arraste prospects aqui</div>' : ''}
            `;
            
            return stage;
        }
        
        // Criar card de prospect
        function criarCardProspect(prospect) {
            return `
                <div class="prospect-card" 
                     draggable="true" 
                     data-prospect-id="${prospect.id}"
                     data-estagio="${prospect.estagio}">
                    <div class="card-nome">
                        ${prospect.nome}
                        <span class="card-probabilidade">${prospect.probabilidade}%</span>
                    </div>
                    <div class="card-empresa">
                        <i class="bi bi-building me-1"></i>
                        ${prospect.empresa || 'Empresa não informada'}
                    </div>
                    <div class="card-valor">
                        R$ ${parseFloat(prospect.valor_estimado || 0).toFixed(2)}
                    </div>
                    <div class="card-contato">
                        ${prospect.email ? `<i class="bi bi-envelope me-1"></i>${prospect.email}<br>` : ''}
                        ${prospect.telefone ? `<i class="bi bi-telephone me-1"></i>${prospect.telefone}` : ''}
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="verDetalhesProspect(${prospect.id})" title="Ver Detalhes">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="adicionarInteracao(${prospect.id})" title="Adicionar Interação">
                            <i class="bi bi-chat-dots"></i>
                        </button>
                        ${prospect.estagio === 'negociacao' ? `
                            <button class="btn btn-sm btn-outline-success" onclick="converterCliente(${prospect.id})" title="Converter em Cliente">
                                <i class="bi bi-person-check"></i>
                            </button>
                        ` : ''}
                        <button class="btn btn-sm btn-outline-secondary" onclick="editarProspect(${prospect.id})" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Configurar drag and drop
        function configurarDragAndDrop() {
            const cards = document.querySelectorAll('.prospect-card');
            const stages = document.querySelectorAll('.pipeline-stage');
            
            cards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });
            
            stages.forEach(stage => {
                stage.addEventListener('dragover', handleDragOver);
                stage.addEventListener('drop', handleDrop);
                stage.addEventListener('dragenter', handleDragEnter);
                stage.addEventListener('dragleave', handleDragLeave);
            });
        }
        
        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.prospectId);
            e.target.classList.add('dragging');
        }
        
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }
        
        function handleDragOver(e) {
            e.preventDefault();
        }
        
        function handleDragEnter(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }
        
        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }
        
        async function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const prospectId = e.dataTransfer.getData('text/plain');
            const novoEstagio = e.currentTarget.dataset.estagio;
            const cardElement = document.querySelector(`[data-prospect-id="${prospectId}"]`);
            const estagioAtual = cardElement.dataset.estagio;
            
            if (estagioAtual !== novoEstagio) {
                await moverProspect(prospectId, novoEstagio);
            }
        }
        
        // Mover prospect
        async function moverProspect(prospectId, novoEstagio) {
            try {
                const response = await fetch(`/api/crm/prospects/${prospectId}/mover`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        estagio: novoEstagio
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await carregarPipeline();
                    mostrarNotificacao('Prospect movido com sucesso!', 'success');
                } else {
                    mostrarNotificacao('Erro ao mover prospect: ' + result.error, 'error');
                }
            } catch (error) {
                mostrarNotificacao('Erro na requisição: ' + error.message, 'error');
            }
        }
        
        // Salvar novo prospect
        async function salvarProspect() {
            const form = document.getElementById('formNovoProspect');
            const formData = new FormData(form);
            const dados = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch('/api/crm/prospects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('novoProspectModal'));
                    modal.hide();
                    form.reset();
                    await carregarPipeline();
                    mostrarNotificacao('Prospect criado com sucesso!', 'success');
                } else {
                    mostrarNotificacao('Erro ao criar prospect: ' + result.error, 'error');
                }
            } catch (error) {
                mostrarNotificacao('Erro na requisição: ' + error.message, 'error');
            }
        }
        
        // Atualizar estatísticas
        function atualizarEstatisticas() {
            let totalProspects = 0;
            let valorTotal = 0;
            let convertidos = 0;

            Object.values(pipelineData).forEach(prospects => {
                prospects.forEach(prospect => {
                    totalProspects++;
                    valorTotal += parseFloat(prospect.valor_estimado || 0);
                    if (prospect.estagio === 'cliente') {
                        convertidos++;
                    }
                });
            });

            const taxaConversao = totalProspects > 0 ? (convertidos / totalProspects * 100).toFixed(1) : 0;

            const totalEl = document.getElementById('total-prospects');
            const valorEl = document.getElementById('valor-pipeline');
            const taxaEl = document.getElementById('taxa-conversao');
            const convertidosEl = document.getElementById('convertidos-mes');

            if (totalEl) totalEl.textContent = totalProspects;
            if (valorEl) valorEl.textContent = `R$ ${valorTotal.toFixed(2)}`;
            if (taxaEl) taxaEl.textContent = `${taxaConversao}%`;
            if (convertidosEl) convertidosEl.textContent = convertidos;
        }
        
        // Funções auxiliares
        function mostrarNotificacao(mensagem, tipo) {
            console.log(`${tipo.toUpperCase()}: ${mensagem}`);
        }
        
        function atualizarPipeline() {
            carregarPipeline();
        }
        
        // Carregar estatísticas do CRM
        async function carregarEstatisticas() {
            try {
                const response = await fetch('/api/crm/estatisticas');
                const stats = await response.json();

                // Atualizar estatísticas gerais
                document.getElementById('total-prospects').textContent = stats.total_prospects || 0;
                document.getElementById('valor-pipeline').textContent = `R$ ${(stats.valor_pipeline || 0).toFixed(2)}`;
                document.getElementById('taxa-conversao').textContent = `${stats.taxa_conversao || 0}%`;
                document.getElementById('ticket-medio').textContent = `R$ ${(stats.ticket_medio || 0).toFixed(2)}`;

            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        // Ver detalhes do prospect
        async function verDetalhesProspect(id) {
            try {
                const response = await fetch(`/api/crm/prospects/${id}`);
                const data = await response.json();

                if (data.prospect) {
                    // Mostrar modal com detalhes (implementar modal)
                    showToast.info('Detalhes', `Prospect: ${data.prospect.nome}`);
                }

            } catch (error) {
                console.error('Erro ao carregar detalhes:', error);
                showToast.error('Erro', 'Erro ao carregar detalhes do prospect');
            }
        }

        // Adicionar interação
        async function adicionarInteracao(id) {
            const tipo = prompt('Tipo de interação (ligacao, email, reuniao, whatsapp):');
            const descricao = prompt('Descrição da interação:');
            const resultado = prompt('Resultado (opcional):');

            if (tipo && descricao) {
                try {
                    const response = await fetch(`/api/crm/prospects/${id}/interacao`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            tipo: tipo,
                            descricao: descricao,
                            resultado: resultado,
                            responsavel: 'Sistema MIMO'
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showToast.success('Interação Adicionada', 'Interação registrada com sucesso');
                    } else {
                        showToast.error('Erro', result.error || 'Erro ao adicionar interação');
                    }

                } catch (error) {
                    console.error('Erro ao adicionar interação:', error);
                    showToast.error('Erro', 'Erro de conexão');
                }
            }
        }

        // Converter prospect em cliente
        async function converterCliente(id) {
            if (confirm('Deseja converter este prospect em cliente?')) {
                try {
                    const response = await fetch(`/api/crm/prospects/${id}/converter`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        showToast.success('Conversão Realizada', `Prospect convertido em cliente! ID: ${result.cliente_id}`);
                        await carregarPipeline();
                        await carregarEstatisticas();
                    } else {
                        showToast.error('Erro', result.error || 'Erro ao converter prospect');
                    }

                } catch (error) {
                    console.error('Erro ao converter prospect:', error);
                    showToast.error('Erro', 'Erro de conexão');
                }
            }
        }

        function editarProspect(id) {
            showToast.info('Em Desenvolvimento', 'Funcionalidade de edição será implementada em breve');
        }

        // Atualizar pipeline
        async function atualizarPipeline() {
            showToast.info('Atualizando', 'Carregando dados mais recentes...');
            await carregarPipeline();
            await carregarEstatisticas();
        }

        // Implementação da função showToast
        const showToast = {
            success: function(title, message) { this.show('success', title, message); },
            error: function(title, message) { this.show('error', title, message); },
            warning: function(title, message) { this.show('warning', title, message); },
            info: function(title, message) { this.show('info', title, message); },
            show: function(type, title, message) {
                let container = document.getElementById('toast-container');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'toast-container';
                    container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 350px;';
                    document.body.appendChild(container);
                }
                const toast = document.createElement('div');
                const colors = {
                    success: { bg: '#d4edda', border: '#c3e6cb', text: '#155724' },
                    error: { bg: '#f8d7da', border: '#f5c6cb', text: '#721c24' },
                    warning: { bg: '#fff3cd', border: '#ffeaa7', text: '#856404' },
                    info: { bg: '#d1ecf1', border: '#bee5eb', text: '#0c5460' }
                };
                const color = colors[type] || colors.info;
                toast.style.cssText = `background: ${color.bg}; border: 1px solid ${color.border}; color: ${color.text}; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);`;
                toast.innerHTML = `<div style="display: flex; align-items: center; justify-content: space-between;"><div><strong>${title}</strong><div style="margin-top: 5px;">${message}</div></div><button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 18px; cursor: pointer; color: ${color.text};">×</button></div>`;
                container.appendChild(toast);
                setTimeout(() => toast.remove(), 5000);
            }
        };

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            carregarPipeline();
            carregarEstatisticas();
        });
    </script>
</body>
</html>
