{% extends "base.html" %}

{% block title %}Nova Venda - Sistema MIMO{% endblock %}

{% block content %}
<div class="container">
    <!-- Cabeçalho -->
    <div class="row mb-4">
        <div class="col">
            <h2 class="mimo-gradient-text">
                <i class="bi bi-cart-plus me-2"></i>
                Nova Venda
            </h2>
            <p class="text-muted">Registre uma nova venda</p>
        </div>
    </div>

    <!-- Formulário Simples -->
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Dados da Venda</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {{ form.hidden_tag() }}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.cliente_id.label(class="form-label") }}
                                {{ form.cliente_id(class="form-select") }}
                                {% if form.cliente_id.errors %}
                                <div class="text-danger">
                                    {% for error in form.cliente_id.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                {{ form.data_entrega.label(class="form-label") }}
                                {{ form.data_entrega(class="form-control") }}
                                {% if form.data_entrega.errors %}
                                <div class="text-danger">
                                    {% for error in form.data_entrega.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                {{ form.valor_entrega.label(class="form-label") }}
                                {{ form.valor_entrega(class="form-control", placeholder="0.00") }}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                {{ form.desconto.label(class="form-label") }}
                                {{ form.desconto(class="form-control", placeholder="0.00") }}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                {{ form.forma_pagamento.label(class="form-label") }}
                                {{ form.forma_pagamento(class="form-select") }}
                            </div>
                            
                            <div class="col-12 mb-3">
                                {{ form.observacoes.label(class="form-label") }}
                                {{ form.observacoes(class="form-control") }}
                            </div>
                        </div>
                        
                        <!-- Produtos Disponíveis -->
                        <h6 class="mt-4 mb-3">Produtos Disponíveis</h6>
                        <div class="row">
                            {% if produtos %}
                            {% for produto in produtos %}
                            <div class="col-md-6 mb-2">
                                <div class="card produto-card" style="cursor: pointer;" 
                                     onclick="adicionarProduto({{ produto.id }}, '{{ produto.nome }}', {{ produto.preco }})">
                                    <div class="card-body p-2">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <small class="fw-bold">{{ produto.nome }}</small>
                                            </div>
                                            <div>
                                                <small class="text-success">R$ {{ "%.2f"|format(produto.preco) }}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            {% else %}
                            <div class="col-12">
                                <p class="text-muted">Nenhum produto disponível</p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Carrinho -->
                        <h6 class="mt-4 mb-3">Carrinho</h6>
                        <div id="carrinho">
                            <p class="text-muted">Carrinho vazio</p>
                        </div>
                        
                        <!-- Total -->
                        <div class="mt-3 p-3 bg-light rounded">
                            <h5>Total: <span id="total">R$ 0,00</span></h5>
                        </div>
                        
                        <!-- Campos ocultos para itens -->
                        <div id="itens-hidden"></div>
                        
                        <div class="mt-4">
                            <button type="submit" class="btn btn-success me-2">
                                <i class="bi bi-check-circle me-2"></i>
                                Criar Venda
                            </button>
                            <a href="{{ url_for('vendas.listar') }}" class="btn btn-secondary">
                                Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let carrinho = [];
let totalGeral = 0;

function adicionarProduto(id, nome, preco) {
    // Verificar se já existe
    const existente = carrinho.find(item => item.id === id);
    
    if (existente) {
        existente.quantidade++;
    } else {
        carrinho.push({
            id: id,
            nome: nome,
            preco: preco,
            quantidade: 1
        });
    }
    
    atualizarCarrinho();
}

function removerProduto(id) {
    carrinho = carrinho.filter(item => item.id !== id);
    atualizarCarrinho();
}

function atualizarCarrinho() {
    const container = document.getElementById('carrinho');
    const hiddenContainer = document.getElementById('itens-hidden');
    
    if (carrinho.length === 0) {
        container.innerHTML = '<p class="text-muted">Carrinho vazio</p>';
        hiddenContainer.innerHTML = '';
        totalGeral = 0;
    } else {
        let html = '';
        let hiddenHtml = '';
        totalGeral = 0;
        
        carrinho.forEach((item, index) => {
            const subtotal = item.preco * item.quantidade;
            totalGeral += subtotal;
            
            html += `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                    <div>
                        <strong>${item.nome}</strong><br>
                        <small>R$ ${item.preco.toFixed(2)} x ${item.quantidade}</small>
                    </div>
                    <div>
                        <span class="me-2">R$ ${subtotal.toFixed(2)}</span>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerProduto(${item.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            hiddenHtml += `
                <input type="hidden" name="produto_id_${index}" value="${item.id}">
                <input type="hidden" name="quantidade_${index}" value="${item.quantidade}">
                <input type="hidden" name="preco_unitario_${index}" value="${item.preco}">
            `;
        });
        
        hiddenHtml += `
            <input type="hidden" name="total_itens" value="${carrinho.length}">
            <input type="hidden" name="valor_total_calculado" value="${totalGeral}">
        `;
        
        container.innerHTML = html;
        hiddenContainer.innerHTML = hiddenHtml;
    }
    
    // Calcular total com taxa e desconto
    const taxa = parseFloat(document.querySelector('[name="valor_entrega"]').value) || 0;
    const desconto = parseFloat(document.querySelector('[name="desconto"]').value) || 0;
    const totalFinal = totalGeral + taxa - desconto;
    
    document.getElementById('total').textContent = `R$ ${totalFinal.toFixed(2)}`;
}

// Recalcular quando mudar taxa ou desconto
document.addEventListener('DOMContentLoaded', function() {
    const taxaInput = document.querySelector('[name="valor_entrega"]');
    const descontoInput = document.querySelector('[name="desconto"]');
    
    if (taxaInput) taxaInput.addEventListener('input', atualizarCarrinho);
    if (descontoInput) descontoInput.addEventListener('input', atualizarCarrinho);
});
</script>
{% endblock %}
